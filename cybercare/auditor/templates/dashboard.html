{% extends "base.html" %}
{% block content %}

<!-- Banda lege -->
<div class="bg-dark text-light py-2 px-3 mb-4 text-center">
  ⚖️ Conformitate cu <strong>Legea 142/2023</strong> și <strong>HG 49/2025</strong>
</div>

<h1 class="mb-4 text-center">🔒 CyberCare – Mini-Audit Dashboard</h1>

<!-- Formular de scanare -->
<form method="post" class="mb-5">
  {% csrf_token %}
  <div class="input-group input-group-lg">
    <input type="text" name="host" placeholder="ex: example.com" class="form-control" required>
    <button class="btn btn-primary"><i class="bi bi-radar me-2"></i>Scanează</button>
  </div>
</form>

{% if result %}
  <!-- Rezumat -->
  <div class="card shadow p-4 mb-4">
    <div class="row align-items-center">
      <div class="col-md-7 mb-4 mb-md-0">
        <p>📅 <b>{{ result.date }}</b> — Domeniu/IP: <b>{{ result.host }}</b></p>
        <p><b>Scor:</b> {{ result.color }} ({{ result.score }}%)</p>
      </div>
      <div class="col-md-5 text-center">
        <!-- Cerc progres SVG -->
        <svg class="progress-ring" width="120" height="120" style="transform: rotate(-90deg);">
          <circle stroke="#ddd" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"/>
          <circle stroke="{% if result.bar_class == 'progress-bar bg-success' %}#00d48f{% elif result.bar_class == 'progress-bar bg-warning' %}#ffcc00{% else %}#ff4d6d{% endif %}"
                  stroke-width="10" fill="transparent" r="52" cx="60" cy="60"
                  stroke-dasharray="{{ result.circumference }}"
                  stroke-dashoffset="{{ result.offset }}"
                  style="transition: stroke-dashoffset 0.35s;"/>
        </svg>

        <!-- Icon scor -->
        <div class="mt-2">
          {% if result.score >= 80 %}
            <i class="bi bi-trophy-fill text-success" style="font-size:2.2rem;"></i>
          {% elif result.score >= 60 %}
            <i class="bi bi-award-fill text-warning" style="font-size:2.2rem;"></i>
          {% else %}
            <i class="bi bi-exclamation-octagon-fill text-danger" style="font-size:2.2rem;"></i>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="mt-3">
      <a href="{% url 'export_pdf' %}" class="btn btn-outline-danger btn-sm">📄 PDF</a>
      <a href="{% url 'export_json' %}" class="btn btn-outline-secondary btn-sm">🗂️ JSON</a>
    </div>
  </div>

  <!-- Istoric -->
  <div class="card shadow p-4 mb-4">
    <h5>Evoluția scorului</h5>
    <canvas id="historyChart" height="120"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('historyChart');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: [{% for h in history %}"{{ h.date }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          label: 'Scor de conformitate',
          data: [{% for h in history %}{{ h.score }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          borderColor: '#007bff',
          backgroundColor: 'rgba(0,123,255,0.1)',
          tension: 0.3,
          fill: true
        }]
      }
    });
  </script>

  <!-- Detalii -->
  <h4 class="mb-3">Rezultate detaliate</h4>
  <div class="row">
    {% for f in result.findings %}
      <div class="col-md-6 mb-3">
        <div class="card p-3 h-100 shadow-sm">
          <h5>{{ f.section }} – {{ f.status }}</h5>
          <p><b>Detalii:</b> {{ f.details }}</p>
          <p><b>Recomandare:</b> {{ f.recommendation }}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Disclaimer -->
  <div class="alert alert-secondary mt-4">
    <i>
      Acest raport are scop informativ și educativ. Nu înlocuiește un audit extern autorizat conform HG nr. 49/2025.
    </i>
  </div>
{% endif %}

{% endblock %}
